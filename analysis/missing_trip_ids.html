<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="crunkel@mbta.com">
<meta name="dcterms.date" content="2025-08-18">

<title>Why are trips missing from LRTP data?</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="missing_trip_ids_files/libs/clipboard/clipboard.min.js"></script>
<script src="missing_trip_ids_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="missing_trip_ids_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="missing_trip_ids_files/libs/quarto-html/popper.min.js"></script>
<script src="missing_trip_ids_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="missing_trip_ids_files/libs/quarto-html/anchor.min.js"></script>
<link href="missing_trip_ids_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="missing_trip_ids_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="missing_trip_ids_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="missing_trip_ids_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="missing_trip_ids_files/libs/bootstrap/bootstrap-81267100e462c21b3d6c0d5bf76a3417.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#the-problem" id="toc-the-problem" class="nav-link active" data-scroll-target="#the-problem">The Problem</a>
  <ul class="collapse">
  <li><a href="#replicating-the-problem" id="toc-replicating-the-problem" class="nav-link" data-scroll-target="#replicating-the-problem">Replicating the problem</a></li>
  </ul></li>
  <li><a href="#where-are-the-missing-trips" id="toc-where-are-the-missing-trips" class="nav-link" data-scroll-target="#where-are-the-missing-trips">Where are the missing trips?</a></li>
  <li><a href="#a-different-way-of-connecting-trips" id="toc-a-different-way-of-connecting-trips" class="nav-link" data-scroll-target="#a-different-way-of-connecting-trips">A different way of connecting trips</a></li>
  <li><a href="#tldr" id="toc-tldr" class="nav-link" data-scroll-target="#tldr">tl;dr</a></li>
  </ul>
</nav>
</div>
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Why are trips missing from LRTP data?</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>crunkel@mbta.com </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 18, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="the-problem" class="level1 page-columns page-full">
<h1>The Problem</h1>
<p>Crissy <a href="https://app.asana.com/1/15492006741476/project/1189492770004753/task/1211080535383270?focus=true">reported</a> that LAMP Tableau data was missing trips that were available in Performance Analyzer. Where are those trips and why aren’t they visible Performance Analyzer?</p>
<div id="516877bc" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> date</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars <span class="im">as</span> pl</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lamp_py.aws <span class="im">import</span> s3</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lamp_py.runtime_utils <span class="im">import</span> remote_files <span class="im">as</span> rf</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>pl.Config(tbl_rows<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>service_date <span class="op">=</span> date(<span class="dv">2025</span>, <span class="dv">8</span>, <span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="replicating-the-problem" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="replicating-the-problem">Replicating the problem</h2>
<p>Firas shared 89 trips from August 6, 2025 along the B line that were not matched by the data LAMP published in Tableau.</p>
<div id="5b229784" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>unmatched <span class="op">=</span> pl.read_csv(<span class="st">"~/Downloads/unmatched_clean.csv"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>unmatched.glimpse()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 89
Columns: 5
$ trip_id           &lt;i64&gt; 69329457, 69329950, 69329956, 69329958, 69329960, 69329962, 69329964, 69329966, 69329968, 69329970
$ consist           &lt;str&gt; '3845-3633', '3805-3647', '3706-3830', '3634-3817', '3706-3830', '3830', '3922', '3809-3696', '3634-3817', '3634-3817'
$ PA_departure_time &lt;str&gt; '2025-08-06 14:53:03 EDT', '2025-08-06 06:29:36 EDT', '2025-08-06 08:39:04 EDT', '2025-08-06 10:48:07 EDT', '2025-08-06 12:46:22 EDT', '2025-08-06 13:56:27 EDT', '2025-08-06 16:20:48 EDT', '2025-08-06 18:40:21 EDT', '2025-08-06 07:04:49 EDT', '2025-08-06 08:46:52 EDT'
$ TB_departure_time &lt;str&gt; None, '2025-08-06 06:39:02 EDT', '2025-08-06 08:46:52 EDT', '2025-08-06 10:40:56 EDT', '2025-08-06 12:46:23 EDT', '2025-08-06 14:29:27 EDT', '2025-08-06 16:30:33 EDT', None, '2025-08-06 07:04:50 EDT', '2025-08-06 08:55:19 EDT'
$ mismatch_reason   &lt;str&gt; 'No matching trip_id in Tableau', 'Departure time difference exceeds tolerance', 'Departure time difference exceeds tolerance', 'Departure time difference exceeds tolerance', 'Generated time difference exceeds tolerance; Predicted departure time difference exceeds tolerance', 'Departure time difference exceeds tolerance', 'Departure time difference exceeds tolerance', 'No matching trip_id in Tableau', 'Generated time difference exceeds tolerance', 'Departure time difference exceeds tolerance'
</code></pre>
</div>
</div>
<p>Trips were matched by:</p>
<blockquote class="blockquote">
<p>trip_ID, prediction generation time, predicted departure time, and actual departure time – going one-way from Prediction Analyzer to Tableau (since Prediction Analyzer has a lower polling rate for predictions, we have much less data for any given service day there vs.&nbsp;Tableau);</p>
<ul>
<li>I ignored the consists for the sake of analysis for now (and we’re not focusing too much on predicted consist at this point in time);</li>
<li>I allowed for a 5-second tolerance for actual departure time as we expect slight differences between Prediction Analyzer and Tableau for this field.</li>
<li>I allowed for a 60-second tolerance for prediction generation time and predicted time as we should at least find a Tableau record that matches to within a minute of every Prediction Analyzer record.</li>
</ul>
</blockquote>
<p>Any unmatched trip must violate one of these conditions. To start investigating this issue, I’ll filter the unmatched dataset down to trips that are listed as totally missing, resulting in 25 trips.</p>
<div id="130b5156" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>missing <span class="op">=</span> (</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    unmatched</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">filter</span>(pl.col(<span class="st">"TB_departure_time"</span>).is_null())</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    .with_columns(pl.col(<span class="st">"trip_id"</span>).cast(<span class="bu">str</span>).alias(<span class="st">"trip_id"</span>))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>missing.glimpse()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 25
Columns: 5
$ trip_id           &lt;str&gt; '69329457', '69329966', '69329986', '69329992', '69330000', '69330008', '69330036', '69330040', '69330048', '69330056'
$ consist           &lt;str&gt; '3845-3633', '3809-3696', '3917', '3845-3633', '3821-3682', '3849-3673', '3914-3917', '3921', '3821-3682', '3861-3659'
$ PA_departure_time &lt;str&gt; '2025-08-06 14:53:03 EDT', '2025-08-06 18:40:21 EDT', '2025-08-06 11:06:25 EDT', '2025-08-06 16:42:31 EDT', '2025-08-06 11:13:09 EDT', '2025-08-06 19:02:45 EDT', '2025-08-06 19:23:04 EDT', '2025-08-06 09:27:06 EDT', '2025-08-06 17:20:37 EDT', '2025-08-06 11:39:39 EDT'
$ TB_departure_time &lt;str&gt; None, None, None, None, None, None, None, None, None, None
$ mismatch_reason   &lt;str&gt; 'No matching trip_id in Tableau', 'No matching trip_id in Tableau', 'No matching trip_id in Tableau', 'No matching trip_id in Tableau', 'No matching trip_id in Tableau', 'No matching trip_id in Tableau', 'No matching trip_id in Tableau', 'No matching trip_id in Tableau', 'No matching trip_id in Tableau', 'No matching trip_id in Tableau'
</code></pre>
</div>
</div>
<p>Starting with missing trips will focus the problem a bit, because it’s easier to check for something that is misisng entirely. Now, let’s double-check that we see the same thing, that these trip IDs are not present in LAMP data for August 6.</p>
<div id="d399a1bb" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>tableau <span class="op">=</span> pl.read_parquet(<span class="st">"s3://mbta-performance/lamp/tableau/gtfs-rt/LAMP_RT_VehiclePositions_LR_60_day.parquet"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can do so by joining the Tableau parquet file to these missing trips. If this join returns no rows, then all the trips are missing in the Tableau data for August 6.</p>
<div id="230d260e" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    missing</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    .join(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        tableau</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">filter</span>(pl.col(<span class="st">"vehicle.trip.start_date"</span>) <span class="op">==</span> <span class="st">"20250806"</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        .group_by(<span class="st">"vehicle.trip.trip_id"</span>, <span class="st">"vehicle.trip.start_time"</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        .agg(pl.<span class="bu">min</span>(<span class="st">"vehicle.timestamp"</span>)),</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        right_on <span class="op">=</span> <span class="st">"vehicle.trip.trip_id"</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        left_on <span class="op">=</span> <span class="st">"trip_id"</span>,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        how <span class="op">=</span> <span class="st">"inner"</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="81">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (1, 7)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">trip_id</th>
<th data-quarto-table-cell-role="th">consist</th>
<th data-quarto-table-cell-role="th">PA_departure_time</th>
<th data-quarto-table-cell-role="th">TB_departure_time</th>
<th data-quarto-table-cell-role="th">mismatch_reason</th>
<th data-quarto-table-cell-role="th">vehicle.trip.start_time</th>
<th data-quarto-table-cell-role="th">vehicle.timestamp</th>
</tr>
<tr class="even">
<th>str</th>
<th>str</th>
<th>str</th>
<th>str</th>
<th>str</th>
<th>str</th>
<th>datetime[μs]</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>"69329457"</td>
<td>"3845-3633"</td>
<td>"2025-08-06 14:53:03 EDT"</td>
<td>null</td>
<td>"No matching trip_id in Tableau"</td>
<td>"14:38:00"</td>
<td>2025-08-06 14:39:40</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Interesting—there is one trip ID among the GTFS data. Let’s look more closely at this trip:</p>
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    tableau</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">filter</span>(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        pl.col(<span class="st">"vehicle.trip.trip_id"</span>) <span class="op">==</span> <span class="st">"69329457"</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        pl.col(<span class="st">"vehicle.trip.start_date"</span>) <span class="op">==</span> <span class="st">"20250806"</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    .group_by(</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"vehicle.trip.trip_id"</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"vehicle.trip.route_id"</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"vehicle.vehicle.label"</span>,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"vehicle.trip.start_time"</span>,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        pl.first(<span class="st">"vehicle.timestamp"</span>).alias(<span class="st">"earliest_timestamp"</span>),</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        pl.first(<span class="st">"vehicle.stop_id"</span>).alias(<span class="st">"first_stop"</span>),</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-existing-trip" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl quarto-uncaptioned" id="tbl-existing-trip-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1
</figcaption>
<div aria-describedby="tbl-existing-trip-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div id="a09d386d" class="cell" data-execution_count="6">
<div class="cell-output cell-output-display" data-execution_count="82">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (2, 6)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">vehicle.trip.trip_id</th>
<th data-quarto-table-cell-role="th">vehicle.trip.route_id</th>
<th data-quarto-table-cell-role="th">vehicle.vehicle.label</th>
<th data-quarto-table-cell-role="th">vehicle.trip.start_time</th>
<th data-quarto-table-cell-role="th">earliest_timestamp</th>
<th data-quarto-table-cell-role="th">first_stop</th>
</tr>
<tr class="even">
<th>str</th>
<th>str</th>
<th>str</th>
<th>str</th>
<th>datetime[μs]</th>
<th>str</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>"69329457"</td>
<td>"Green-D"</td>
<td>"3713-3859"</td>
<td>"14:38:00"</td>
<td>2025-08-06 14:39:40</td>
<td>"70162"</td>
</tr>
<tr class="even">
<td>"69329457"</td>
<td>"Green-D"</td>
<td>"3859-3713"</td>
<td>"14:38:00"</td>
<td>2025-08-06 14:40:13</td>
<td>"70162"</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</figure>
</div>
<p>Okay, so GTFS-RT has this trip ID but:</p>
<ol type="1">
<li>on the D line</li>
<li>with a different consist than expected</li>
</ol>

<div class="no-row-height column-margin column-container"><div class="">
<p>We also see that this trip has 2 rows with the consist flipped. Why? Did a pullout inspector assign the trip and then change the consist from the last trip?</p>
</div></div></section>
</section>
<section id="where-are-the-missing-trips" class="level1">
<h1>Where are the missing trips?</h1>
<p>As for the other trip IDs, it’s worth noting that some <em>do</em> exist for other dates:</p>
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    missing</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    .join(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>        tableau.select(<span class="st">"vehicle.trip.trip_id"</span>, <span class="st">"vehicle.trip.start_date"</span>),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        right_on <span class="op">=</span> <span class="st">"vehicle.trip.trip_id"</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        left_on <span class="op">=</span> <span class="st">"trip_id"</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        how <span class="op">=</span> <span class="st">"inner"</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    .select(<span class="st">"trip_id"</span>, <span class="st">"vehicle.trip.start_date"</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    .group_by(pl.col(<span class="st">"vehicle.trip.start_date"</span>).<span class="bu">str</span>.to_date(<span class="st">"%Y%m</span><span class="sc">%d</span><span class="st">"</span>))</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    .n_unique()</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    .sort(<span class="st">"vehicle.trip.start_date"</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    .rename({</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"vehicle.trip.start_date"</span>: <span class="st">"Service Date"</span>,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"trip_id"</span>: <span class="st">"Count of Missing Trip IDs Present in GFTS-RT"</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-existing-trips-other-dates" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-existing-trips-other-dates-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Trips missing from August 6 that appear on other service dates
</figcaption>
<div aria-describedby="tbl-existing-trips-other-dates-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div id="eed92521" class="cell" data-execution_count="7">
<div class="cell-output cell-output-display" data-execution_count="83">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (43, 2)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Service Date</th>
<th data-quarto-table-cell-role="th">Count of Missing Trip IDs Present in GFTS-RT</th>
</tr>
<tr class="even">
<th>date</th>
<th>u32</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2025-06-20</td>
<td>6</td>
</tr>
<tr class="even">
<td>2025-06-23</td>
<td>10</td>
</tr>
<tr class="odd">
<td>2025-06-24</td>
<td>14</td>
</tr>
<tr class="even">
<td>2025-06-25</td>
<td>10</td>
</tr>
<tr class="odd">
<td>2025-06-26</td>
<td>11</td>
</tr>
<tr class="even">
<td>2025-06-27</td>
<td>19</td>
</tr>
<tr class="odd">
<td>2025-06-30</td>
<td>12</td>
</tr>
<tr class="even">
<td>2025-07-01</td>
<td>14</td>
</tr>
<tr class="odd">
<td>2025-07-02</td>
<td>20</td>
</tr>
<tr class="even">
<td>2025-07-03</td>
<td>19</td>
</tr>
<tr class="odd">
<td>2025-07-07</td>
<td>12</td>
</tr>
<tr class="even">
<td>2025-07-08</td>
<td>20</td>
</tr>
<tr class="odd">
<td>2025-07-09</td>
<td>17</td>
</tr>
<tr class="even">
<td>2025-07-10</td>
<td>14</td>
</tr>
<tr class="odd">
<td>2025-07-11</td>
<td>19</td>
</tr>
<tr class="even">
<td>2025-07-14</td>
<td>11</td>
</tr>
<tr class="odd">
<td>2025-07-15</td>
<td>11</td>
</tr>
<tr class="even">
<td>2025-07-16</td>
<td>15</td>
</tr>
<tr class="odd">
<td>2025-07-17</td>
<td>12</td>
</tr>
<tr class="even">
<td>2025-07-18</td>
<td>15</td>
</tr>
<tr class="odd">
<td>2025-07-21</td>
<td>11</td>
</tr>
<tr class="even">
<td>2025-07-22</td>
<td>8</td>
</tr>
<tr class="odd">
<td>2025-07-23</td>
<td>8</td>
</tr>
<tr class="even">
<td>2025-07-24</td>
<td>20</td>
</tr>
<tr class="odd">
<td>2025-07-25</td>
<td>21</td>
</tr>
<tr class="even">
<td>2025-07-28</td>
<td>16</td>
</tr>
<tr class="odd">
<td>2025-07-29</td>
<td>11</td>
</tr>
<tr class="even">
<td>2025-07-30</td>
<td>12</td>
</tr>
<tr class="odd">
<td>2025-07-31</td>
<td>17</td>
</tr>
<tr class="even">
<td>2025-08-01</td>
<td>22</td>
</tr>
<tr class="odd">
<td>2025-08-04</td>
<td>17</td>
</tr>
<tr class="even">
<td>2025-08-05</td>
<td>18</td>
</tr>
<tr class="odd">
<td>2025-08-06</td>
<td>1</td>
</tr>
<tr class="even">
<td>2025-08-07</td>
<td>14</td>
</tr>
<tr class="odd">
<td>2025-08-08</td>
<td>18</td>
</tr>
<tr class="even">
<td>2025-08-11</td>
<td>8</td>
</tr>
<tr class="odd">
<td>2025-08-12</td>
<td>12</td>
</tr>
<tr class="even">
<td>2025-08-13</td>
<td>10</td>
</tr>
<tr class="odd">
<td>2025-08-14</td>
<td>18</td>
</tr>
<tr class="even">
<td>2025-08-15</td>
<td>17</td>
</tr>
<tr class="odd">
<td>2025-08-18</td>
<td>7</td>
</tr>
<tr class="even">
<td>2025-08-19</td>
<td>18</td>
</tr>
<tr class="odd">
<td>2025-08-20</td>
<td>2</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</figure>
</div>
<p>Can the GTFS Schedule tell us more about these trip IDs? If they appear on other service dates, chances are they’re on our schedule. To check this, we first need the GTFS Schedule tables for trips and stop times.</p>
<div id="b20f1bc6" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>trips <span class="op">=</span> (</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    pl.scan_parquet(<span class="st">"s3://mbta-performance/lamp/gtfs_archive/2025/stop_times.parquet"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">filter</span>(pl.col(<span class="st">"stop_sequence"</span>) <span class="op">==</span> <span class="dv">1</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    .join(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        pl.scan_parquet(<span class="st">"s3://mbta-performance/lamp/gtfs_archive/2025/trips.parquet"</span>),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        on <span class="op">=</span> <span class="st">"trip_id"</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        how <span class="op">=</span> <span class="st">"inner"</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    .select(<span class="st">"trip_id"</span>, <span class="st">"departure_time"</span>, <span class="st">"stop_id"</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    .collect()</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>I’ve pulled in the first <code>stop_id</code> and <code>departure_time</code> for each scheduled trip so that we can compare those to Prediction Analyzer’s departure times from Boston College (<code>70106</code>).</p>
<div id="6229a814" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    missing</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    .select(<span class="st">"trip_id"</span>, <span class="st">"consist"</span>, <span class="st">"PA_departure_time"</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    .join(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        trips.rename({</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"departure_time"</span>: <span class="st">"Scheduled departure time"</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">"stop_id"</span>: <span class="st">"Scheduled terminal"</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        }),</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>        on <span class="op">=</span> <span class="st">"trip_id"</span>,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        how <span class="op">=</span> <span class="st">"left"</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="85">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (25, 5)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">trip_id</th>
<th data-quarto-table-cell-role="th">consist</th>
<th data-quarto-table-cell-role="th">PA_departure_time</th>
<th data-quarto-table-cell-role="th">Scheduled departure time</th>
<th data-quarto-table-cell-role="th">Scheduled terminal</th>
</tr>
<tr class="even">
<th>str</th>
<th>str</th>
<th>str</th>
<th>str</th>
<th>str</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>"69329457"</td>
<td>"3845-3633"</td>
<td>"2025-08-06 14:53:03 EDT"</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>"69329966"</td>
<td>"3809-3696"</td>
<td>"2025-08-06 18:40:21 EDT"</td>
<td>"18:26:00"</td>
<td>"70106"</td>
</tr>
<tr class="odd">
<td>"69329986"</td>
<td>"3917"</td>
<td>"2025-08-06 11:06:25 EDT"</td>
<td>"10:56:00"</td>
<td>"70106"</td>
</tr>
<tr class="even">
<td>"69329992"</td>
<td>"3845-3633"</td>
<td>"2025-08-06 16:42:31 EDT"</td>
<td>"16:45:00"</td>
<td>"70106"</td>
</tr>
<tr class="odd">
<td>"69330000"</td>
<td>"3821-3682"</td>
<td>"2025-08-06 11:13:09 EDT"</td>
<td>"11:05:00"</td>
<td>"70106"</td>
</tr>
<tr class="even">
<td>"69330008"</td>
<td>"3849-3673"</td>
<td>"2025-08-06 19:02:45 EDT"</td>
<td>"18:55:00"</td>
<td>"70106"</td>
</tr>
<tr class="odd">
<td>"69330036"</td>
<td>"3914-3917"</td>
<td>"2025-08-06 19:23:04 EDT"</td>
<td>"19:13:00"</td>
<td>"70106"</td>
</tr>
<tr class="even">
<td>"69330040"</td>
<td>"3921"</td>
<td>"2025-08-06 09:27:06 EDT"</td>
<td>"09:35:00"</td>
<td>"70106"</td>
</tr>
<tr class="odd">
<td>"69330048"</td>
<td>"3821-3682"</td>
<td>"2025-08-06 17:20:37 EDT"</td>
<td>"17:20:00"</td>
<td>"70106"</td>
</tr>
<tr class="even">
<td>"69330056"</td>
<td>"3861-3659"</td>
<td>"2025-08-06 11:39:39 EDT"</td>
<td>"11:38:00"</td>
<td>"70106"</td>
</tr>
<tr class="odd">
<td>"69330062"</td>
<td>"3717-3880"</td>
<td>"2025-08-06 17:28:41 EDT"</td>
<td>"17:28:00"</td>
<td>"70106"</td>
</tr>
<tr class="even">
<td>"69330064"</td>
<td>"3717-3880"</td>
<td>"2025-08-06 19:38:03 EDT"</td>
<td>"19:29:00"</td>
<td>"70106"</td>
</tr>
<tr class="odd">
<td>"69330068"</td>
<td>"3861-3659"</td>
<td>"2025-08-06 09:44:35 EDT"</td>
<td>"09:51:00"</td>
<td>"70106"</td>
</tr>
<tr class="even">
<td>"69330080"</td>
<td>"3805-3647"</td>
<td>"2025-08-06 10:04:34 EDT"</td>
<td>"09:59:00"</td>
<td>"70106"</td>
</tr>
<tr class="odd">
<td>"69330090"</td>
<td>"3805-3647"</td>
<td>"2025-08-06 08:06:55 EDT"</td>
<td>"08:15:00"</td>
<td>"70106"</td>
</tr>
<tr class="even">
<td>"69330112"</td>
<td>"3604-3871"</td>
<td>null</td>
<td>"18:00:00"</td>
<td>"70106"</td>
</tr>
<tr class="odd">
<td>"69330124"</td>
<td>"3805-3647"</td>
<td>"2025-08-06 18:20:35 EDT"</td>
<td>"18:09:00"</td>
<td>"70106"</td>
</tr>
<tr class="even">
<td>"69330132"</td>
<td>"3849-3673"</td>
<td>"2025-08-06 14:54:46 EDT"</td>
<td>"14:21:00"</td>
<td>"70106"</td>
</tr>
<tr class="odd">
<td>"69330138"</td>
<td>"3919-3915"</td>
<td>"2025-08-06 19:48:05 EDT"</td>
<td>"19:38:00"</td>
<td>"70106"</td>
</tr>
<tr class="even">
<td>"69330142"</td>
<td>"3921"</td>
<td>"2025-08-06 20:04:50 EDT"</td>
<td>"19:56:00"</td>
<td>"70106"</td>
</tr>
<tr class="odd">
<td>"69330148"</td>
<td>"3805-3647"</td>
<td>"2025-08-06 20:21:25 EDT"</td>
<td>"20:22:00"</td>
<td>"70106"</td>
</tr>
<tr class="even">
<td>"69330152"</td>
<td>"3809-3696"</td>
<td>"2025-08-06 20:34:40 EDT"</td>
<td>"20:41:00"</td>
<td>"70106"</td>
</tr>
<tr class="odd">
<td>"69330162"</td>
<td>"3821-3682"</td>
<td>"2025-08-06 21:23:07 EDT"</td>
<td>"21:27:00"</td>
<td>"70106"</td>
</tr>
<tr class="even">
<td>"69330166"</td>
<td>"3919-3915"</td>
<td>"2025-08-06 21:46:25 EDT"</td>
<td>"21:45:00"</td>
<td>"70106"</td>
</tr>
<tr class="odd">
<td>"69330172"</td>
<td>"3604-3871"</td>
<td>"2025-08-06 22:23:06 EDT"</td>
<td>"22:13:00"</td>
<td>"70106"</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The first thing I see is that the only trip present in the Prediction Analyzer dataset that has no match in our schedule is the D-line trip that GTFS-RT reported. This begs the question <strong>how does an unscheduled trip get 1 trip ID in Prediction Analyzer and a different trip ID in GTFS-RT?</strong></p>
<p>The second thing I see is that the scheduled trip times are off of the departure times reported by Prediction Analyzer by several minutes but are somewhat close to the scheduled trip times. <strong>Can we use the times to re-connect Prediction Analyzer to a GTFS-RT?</strong></p>
</section>
<section id="a-different-way-of-connecting-trips" class="level1">
<h1>A different way of connecting trips</h1>
<p>Instead of connecting trips in Prediction Analyzer to GFTS-RT by ID, can we connect trips using time? Let’s start with one trip, the scheduled D-line trip that appeared on the B-line. We’ll connect the trip by using the nearest LTRP timestamp on the B-line.</p>
<div id="311a7bd5" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    missing</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">filter</span>(pl.col(<span class="st">"trip_id"</span>) <span class="op">==</span> <span class="st">"69329457"</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    .with_columns(pl.col(<span class="st">"PA_departure_time"</span>).<span class="bu">str</span>.to_datetime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S %Z"</span>))</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    .join_asof(</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        tableau</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">filter</span>(pl.col(<span class="st">"vehicle.trip.route_id"</span>) <span class="op">==</span> <span class="st">"Green-B"</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">filter</span>(pl.col(<span class="st">"vehicle.trip.start_date"</span>) <span class="op">==</span> <span class="st">"20250806"</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        .sort(<span class="st">"vehicle.timestamp"</span>),</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        left_on <span class="op">=</span> <span class="st">"PA_departure_time"</span>,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        right_on <span class="op">=</span> <span class="st">"vehicle.timestamp"</span>,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        strategy <span class="op">=</span> <span class="st">"nearest"</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    .select(</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"PA_departure_time"</span>,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"vehicle.timestamp"</span>,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"trip_id"</span>,</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"vehicle.trip.trip_id"</span>,</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"vehicle.trip.route_id"</span>,</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"consist"</span>,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"vehicle.vehicle.label"</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="86">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (1, 7)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">PA_departure_time</th>
<th data-quarto-table-cell-role="th">vehicle.timestamp</th>
<th data-quarto-table-cell-role="th">trip_id</th>
<th data-quarto-table-cell-role="th">vehicle.trip.trip_id</th>
<th data-quarto-table-cell-role="th">vehicle.trip.route_id</th>
<th data-quarto-table-cell-role="th">consist</th>
<th data-quarto-table-cell-role="th">vehicle.vehicle.label</th>
</tr>
<tr class="even">
<th>datetime[μs]</th>
<th>datetime[μs]</th>
<th>str</th>
<th>str</th>
<th>str</th>
<th>str</th>
<th>str</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2025-08-06 14:53:03</td>
<td>2025-08-06 14:53:03</td>
<td>"69329457"</td>
<td>"69329990"</td>
<td>"Green-B"</td>
<td>"3845-3633"</td>
<td>"3845-3633"</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Woah, this strategy returns an exact time match. What’s more, it also returns an exact consist match. <strong>Can we use consist and time but ignore <code>trip_id</code> to find the unmatched trips?</strong></p>
<p>To test this, I’ll join all the trips Firas listed as unmatched to the trips in our Tableau data but, instead of joining on trip ID, I’ll join on</p>
<ul>
<li>consist</li>
<li>stop (in this case, the second-to-last stop on the B-line <code>South Street</code>)</li>
<li>closest time point</li>
</ul>
<div id="93b8803b" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>consist_time_join <span class="op">=</span> (</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    unmatched</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    .with_columns(pl.col(<span class="st">"PA_departure_time"</span>).<span class="bu">str</span>.to_datetime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S %Z"</span>))</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    .sort(<span class="st">"PA_departure_time"</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    .join_asof(</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        tableau</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">filter</span>(pl.col(<span class="st">"vehicle.trip.route_id"</span>) <span class="op">==</span> <span class="st">"Green-B"</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">filter</span>(pl.col(<span class="st">"vehicle.trip.start_date"</span>) <span class="op">==</span> <span class="st">"20250806"</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        .sort(<span class="st">"vehicle.timestamp"</span>),</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        left_on <span class="op">=</span> <span class="st">"PA_departure_time"</span>,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        right_on <span class="op">=</span> <span class="st">"vehicle.timestamp"</span>,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        by_left <span class="op">=</span> <span class="st">"consist"</span>,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        by_right <span class="op">=</span> <span class="st">"vehicle.vehicle.label"</span>,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        strategy <span class="op">=</span> <span class="st">"nearest"</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    .select(</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"consist"</span>,</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"PA_departure_time"</span>,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"vehicle.timestamp"</span>,</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"trip_id"</span>,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"vehicle.trip.trip_id"</span>,</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"vehicle.trip.route_id"</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Doing so results in an exact match for each trip with a listed departure time in Prediction Analyzer:</p>
<div id="33fe386c" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>consist_time_join</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="88">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (89, 6)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">consist</th>
<th data-quarto-table-cell-role="th">PA_departure_time</th>
<th data-quarto-table-cell-role="th">vehicle.timestamp</th>
<th data-quarto-table-cell-role="th">trip_id</th>
<th data-quarto-table-cell-role="th">vehicle.trip.trip_id</th>
<th data-quarto-table-cell-role="th">vehicle.trip.route_id</th>
</tr>
<tr class="even">
<th>str</th>
<th>datetime[μs]</th>
<th>datetime[μs]</th>
<th>i64</th>
<th>str</th>
<th>str</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>"3695-3844"</td>
<td>null</td>
<td>null</td>
<td>69329984</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>"3919-3915"</td>
<td>null</td>
<td>null</td>
<td>69330074</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>"3861-3659"</td>
<td>null</td>
<td>null</td>
<td>69330078</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>"3861-3659"</td>
<td>null</td>
<td>null</td>
<td>69330086</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>"3805-3647"</td>
<td>null</td>
<td>null</td>
<td>69330094</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>"3904-3922"</td>
<td>null</td>
<td>null</td>
<td>69330106</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>"3604-3871"</td>
<td>null</td>
<td>null</td>
<td>69330112</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>"3673-3849"</td>
<td>null</td>
<td>null</td>
<td>69330126</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>"3845-3633"</td>
<td>null</td>
<td>null</td>
<td>69330154</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>"3805-3647"</td>
<td>2025-08-06 06:29:36</td>
<td>2025-08-06 06:29:36</td>
<td>69329950</td>
<td>"69329928"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3634-3817"</td>
<td>2025-08-06 07:04:49</td>
<td>2025-08-06 07:04:49</td>
<td>69329968</td>
<td>"69329968"</td>
<td>"Green-B"</td>
</tr>
<tr class="even">
<td>"3695-3844"</td>
<td>2025-08-06 07:10:54</td>
<td>2025-08-06 07:10:54</td>
<td>69329996</td>
<td>"69329982"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3914-3917"</td>
<td>2025-08-06 07:17:06</td>
<td>2025-08-06 07:17:06</td>
<td>69330010</td>
<td>"69329936"</td>
<td>"Green-B"</td>
</tr>
<tr class="even">
<td>"3821-3682"</td>
<td>2025-08-06 07:28:55</td>
<td>2025-08-06 07:28:55</td>
<td>69330024</td>
<td>"69329939"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3717-3880"</td>
<td>2025-08-06 07:34:55</td>
<td>2025-08-06 07:34:55</td>
<td>69330052</td>
<td>"69330024"</td>
<td>"Green-B"</td>
</tr>
<tr class="even">
<td>"3905-3921"</td>
<td>2025-08-06 07:45:01</td>
<td>2025-08-06 07:45:01</td>
<td>69330066</td>
<td>"69330038"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3805-3647"</td>
<td>2025-08-06 08:06:55</td>
<td>2025-08-06 08:06:55</td>
<td>69330090</td>
<td>"69330078"</td>
<td>"Green-B"</td>
</tr>
<tr class="even">
<td>"3922"</td>
<td>2025-08-06 08:15:05</td>
<td>2025-08-06 08:15:05</td>
<td>69330102</td>
<td>"ADDED-1582982918"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3809-3696"</td>
<td>2025-08-06 08:26:52</td>
<td>2025-08-06 08:26:52</td>
<td>69330114</td>
<td>"69329951"</td>
<td>"Green-B"</td>
</tr>
<tr class="even">
<td>"3706-3830"</td>
<td>2025-08-06 08:39:04</td>
<td>2025-08-06 08:39:04</td>
<td>69329956</td>
<td>"69329954"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3634-3817"</td>
<td>2025-08-06 08:46:52</td>
<td>2025-08-06 08:46:52</td>
<td>69329970</td>
<td>"69329956"</td>
<td>"Green-B"</td>
</tr>
<tr class="even">
<td>"3914-3917"</td>
<td>2025-08-06 09:02:50</td>
<td>2025-08-06 09:02:50</td>
<td>69329998</td>
<td>"69329984"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3821-3682; 3717-3880"</td>
<td>2025-08-06 09:11:10</td>
<td>null</td>
<td>69330012</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>"3717-3880"</td>
<td>2025-08-06 09:20:54</td>
<td>2025-08-06 09:20:54</td>
<td>69330026</td>
<td>"69330012"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3921"</td>
<td>2025-08-06 09:27:06</td>
<td>2025-08-06 09:27:06</td>
<td>69330040</td>
<td>"ADDED-1582983025"</td>
<td>"Green-B"</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="odd">
<td>"3845-3633"</td>
<td>2025-08-06 18:50:42</td>
<td>2025-08-06 18:50:42</td>
<td>69329980</td>
<td>"69329994"</td>
<td>"Green-B"</td>
</tr>
<tr class="even">
<td>"3849-3673"</td>
<td>2025-08-06 19:02:45</td>
<td>2025-08-06 19:02:45</td>
<td>69330008</td>
<td>"ADDED-1582984426"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3852-3634"</td>
<td>2025-08-06 19:14:51</td>
<td>2025-08-06 19:14:51</td>
<td>69330022</td>
<td>"ADDED-1582984447"</td>
<td>"Green-B"</td>
</tr>
<tr class="even">
<td>"3914-3917"</td>
<td>2025-08-06 19:23:04</td>
<td>2025-08-06 19:23:04</td>
<td>69330036</td>
<td>"ADDED-1582984456"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3821-3682"</td>
<td>2025-08-06 19:31:25</td>
<td>2025-08-06 19:31:25</td>
<td>69330050</td>
<td>"ADDED-1582984468"</td>
<td>"Green-B"</td>
</tr>
<tr class="even">
<td>"3717-3880"</td>
<td>2025-08-06 19:38:03</td>
<td>2025-08-06 19:38:03</td>
<td>69330064</td>
<td>"ADDED-1582984478"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3919-3915"</td>
<td>2025-08-06 19:48:05</td>
<td>2025-08-06 19:48:05</td>
<td>69330138</td>
<td>"69330140"</td>
<td>"Green-B"</td>
</tr>
<tr class="even">
<td>"3861-3659"</td>
<td>2025-08-06 19:56:21</td>
<td>2025-08-06 19:56:21</td>
<td>69330140</td>
<td>"ADDED-1582984501"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3921"</td>
<td>2025-08-06 20:04:50</td>
<td>2025-08-06 20:04:50</td>
<td>69330142</td>
<td>"ADDED-1582984513"</td>
<td>"Green-B"</td>
</tr>
<tr class="even">
<td>"3604-3871"</td>
<td>2025-08-06 20:13:06</td>
<td>2025-08-06 20:13:06</td>
<td>69330144</td>
<td>"ADDED-1582984536"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3805-3647"</td>
<td>2025-08-06 20:21:25</td>
<td>2025-08-06 20:21:25</td>
<td>69330148</td>
<td>"ADDED-1582984547"</td>
<td>"Green-B"</td>
</tr>
<tr class="even">
<td>"3809-3696"</td>
<td>2025-08-06 20:34:40</td>
<td>2025-08-06 20:34:40</td>
<td>69330152</td>
<td>"ADDED-1582984559"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3849-3673"</td>
<td>2025-08-06 20:54:49</td>
<td>2025-08-06 20:54:49</td>
<td>69330158</td>
<td>"ADDED-1582984602"</td>
<td>"Green-B"</td>
</tr>
<tr class="even">
<td>"3914-3917"</td>
<td>2025-08-06 21:13:11</td>
<td>2025-08-06 21:13:11</td>
<td>69330160</td>
<td>"69330158"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3821-3682"</td>
<td>2025-08-06 21:23:07</td>
<td>2025-08-06 21:23:07</td>
<td>69330162</td>
<td>"69330160"</td>
<td>"Green-B"</td>
</tr>
<tr class="even">
<td>"3919-3915"</td>
<td>2025-08-06 21:46:25</td>
<td>2025-08-06 21:46:25</td>
<td>69330166</td>
<td>"ADDED-1582984672"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3861-3659"</td>
<td>2025-08-06 21:59:40</td>
<td>2025-08-06 21:59:40</td>
<td>69330168</td>
<td>"69330168"</td>
<td>"Green-B"</td>
</tr>
<tr class="even">
<td>"3604-3871"</td>
<td>2025-08-06 22:23:06</td>
<td>2025-08-06 22:23:06</td>
<td>69330172</td>
<td>"69330174"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3805-3647"</td>
<td>2025-08-06 22:31:38</td>
<td>2025-08-06 22:31:38</td>
<td>69330174</td>
<td>"69330176"</td>
<td>"Green-B"</td>
</tr>
<tr class="even">
<td>"3845-3633"</td>
<td>2025-08-06 22:34:45</td>
<td>2025-08-06 22:59:42</td>
<td>69330178</td>
<td>"ADDED-1582984792"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3809-3696"</td>
<td>2025-08-06 22:41:25</td>
<td>2025-08-06 22:41:25</td>
<td>69330176</td>
<td>"69330178"</td>
<td>"Green-B"</td>
</tr>
<tr class="even">
<td>"3852-3634"</td>
<td>2025-08-06 22:50:03</td>
<td>2025-08-06 22:50:03</td>
<td>69330182</td>
<td>"69330157"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3821-3682"</td>
<td>2025-08-06 23:19:31</td>
<td>2025-08-06 23:19:31</td>
<td>69330184</td>
<td>"69330186"</td>
<td>"Green-B"</td>
</tr>
<tr class="even">
<td>"3717-3880"</td>
<td>2025-08-06 23:31:34</td>
<td>2025-08-06 23:31:34</td>
<td>69330188</td>
<td>"69330188"</td>
<td>"Green-B"</td>
</tr>
<tr class="odd">
<td>"3919-3915"</td>
<td>2025-08-06 23:43:00</td>
<td>2025-08-06 23:43:00</td>
<td>69330190</td>
<td>"69330190"</td>
<td>"Green-B"</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>None of the trip IDs match but the right car is at the right stop at the right time.</p>
</section>
<section id="tldr" class="level1">
<h1>tl;dr</h1>
<p>Prediction Analyzer and GTFS-RT agree on which Green Line trains are running on a track but do not agree on which trip IDs to assign those cars. Why do trip IDs not match between the 2 systems?</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>